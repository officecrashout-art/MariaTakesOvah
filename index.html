<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Maria's Birthday Quest</title>
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            margin: 0; padding: 0; overflow: hidden; 
            background: #1a1a2e; font-family: sans-serif; 
            touch-action: none; width: 100vw; height: 100vh;
        }
        canvas { display: block; width: 100%; height: 100%; }

        /* UI ELEMENTS */
        #ui { position: absolute; top: 15px; left: 15px; z-index: 10; pointer-events: none; }
        .stats { background: rgba(0,0,0,0.8); padding: 10px; border: 2px solid #00ffff; border-radius: 8px; color: #ffff00; font-size: 18px; font-weight: bold; }
        #health-bar { width: 150px; height: 12px; background: #333; border: 1px solid #fff; border-radius: 6px; margin-top: 5px; overflow: hidden; }
        #health-fill { width: 100%; height: 100%; background: #ff0000; transition: width 0.2s; }
        
        #btnR { 
            position: absolute; top: 15px; right: 15px; width: 50px; height: 50px; 
            background: rgba(255,255,255,0.2); border: 2px solid #fff; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: white; font-weight: bold; z-index: 30; cursor: pointer; pointer-events: auto;
        }

        #hint {
            position: absolute; top: 20%; left: 50%; transform: translateX(-50%);
            color: white; font-size: 18px; background: rgba(0,0,0,0.5); padding: 10px 20px;
            border-radius: 20px; z-index: 5; animation: blink 1.5s infinite;
        }

        #msg { 
            position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%); 
            font-size: 32px; text-align: center; display: none; background: rgba(0,0,0,0.9); 
            padding: 30px; border: 5px solid #ff00ff; color: #00ffff; border-radius: 15px; z-index: 20; width: 85%;
        }

        @keyframes blink { 0% { opacity: 0.2; } 50% { opacity: 1; } 100% { opacity: 0.2; } }

        /* MOBILE CONTROLS */
        .controls { 
            position: absolute; bottom: 50px; left: 0; width: 100%; 
            display: flex; justify-content: space-between; 
            padding: 0 30px; pointer-events: none; 
        }
        .btn-group { display: flex; gap: 20px; pointer-events: none; }
        .btn { 
            width: 80px; height: 80px; background: rgba(255,255,255,0.15); 
            border-radius: 50%; display: flex; align-items: center; justify-content: center; 
            font-weight: bold; color: white; border: 3px solid rgba(255,255,255,0.6); 
            pointer-events: auto; user-select: none;
        }
        .btn:active { background: rgba(255,255,255,0.4); transform: scale(0.9); }
        .btn-fire { background: rgba(255, 0, 0, 0.3); border-color: #ff4444; }
    </style>
</head>
<body>
    <div id="ui"><div class="stats">SCORE: <span id="score">0000</span></div><div id="health-bar"><div id="health-fill"></div></div></div>
    <div id="btnR">R</div>
    <div id="hint">Double Jump to Fly!</div>
    <div id="msg">HAPPY BIRTHDAY MARIA!</div>

    <div class="controls">
        <div class="btn-group">
            <div id="btnL" class="btn">←</div>
            <div id="btnRight" class="btn">→</div>
        </div>
        <div class="btn-group">
            <div id="btnShoot" class="btn btn-fire">FIRE</div>
            <div id="btnJump" class="btn">JUMP</div>
        </div>
    </div>

    <canvas id="gameCanvas"></canvas>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
window.addEventListener('resize', resize); resize();

// --- ASSETS ---
const sndShoot = new Audio('shoot.mp3');
const sndHit = new Audio('hit.mp3');
const sndBGM = new Audio('bgm.mp3'); sndBGM.loop = true;
let bgmOn = false;

const mariaImg = new Image(); mariaImg.src = 'Gemini_Generated_Image_b9w7vcb9w7vcb9w7-removebg-preview.png';
const zombieImg = new Image(); zombieImg.src = 'zombie.png';
const frankImg = new Image(); frankImg.src = 'frank.png';
const castleImg = new Image(); castleImg.src = 'castle.png';

// --- STATE ---
let score = 0, hp = 100, camX = 0, isWin = false, invuln = 0, lastTime = performance.now();
let bullets = [], particles = [], confetti = [], keys = {}, touch = {L:false, R:false};
let gateOpen = 0, firstJump = false;

const p = { x: 150, y: 100, w: 120, h: 180, vx: 0, vy: 0, jumps: 0, face: 1 };
const platforms = [
    { x: 0, y: canvas.height - 80, w: 12000, h: 100 },
    { x: 1400, y: canvas.height - 450, w: 120, h: 450, wall: true },
    { x: 2800, y: canvas.height - 350, w: 700, h: 40 }
];

const enemies = [
    { x: 1000, y: canvas.height - 240, w: 100, h: 160, vx: 3, img: zombieImg, start: 1000, range: 400 },
    { x: 2500, y: canvas.height - 240, w: 110, h: 160, vx: 2, img: frankImg, start: 2500, range: 300 },
    { x: 5000, y: canvas.height - 240, w: 100, h: 160, vx: 5, img: zombieImg, start: 5000, range: 600 },
    { x: 8000, y: canvas.height - 240, w: 110, h: 160, vx: 3, img: frankImg, start: 7800, range: 600 }
];
const finishLine = 10100;
const castlePos = { x: 10000, y: canvas.height - 650, w: 500, h: 600 };

// --- HELPERS ---
function startBGM() { if(!bgmOn) { sndBGM.play().catch(()=>{}); bgmOn = true; } }
function createConfetti(x, y) {
    for (let i = 0; i < 8; i++) {
        confetti.push({ x, y, vx: (Math.random()-0.5)*15, vy: (Math.random()-1)*15, size: Math.random()*8+4, color: `hsl(${Math.random()*360},100%,50%)`, life: 100 });
    }
}
function doJump() { 
    if(p.jumps < 2) { 
        p.vy = -18; p.jumps++; 
        if(!firstJump) { firstJump = true; document.getElementById('hint').style.display = 'none'; }
    } 
}
function doShoot() { 
    if(isWin) return;
    bullets.push({x: p.x+(p.face===1?p.w:0), y: p.y+70, vx: p.face*22, life: 80});
    sndShoot.currentTime = 0; sndShoot.play().catch(()=>{}); 
}

// --- INPUT HANDLERS ---
window.onkeydown = e => { startBGM(); keys[e.code] = true; if(['Space','ArrowUp','KeyW'].includes(e.code)) { e.preventDefault(); doJump(); } if(['KeyF','KeyK','ShiftLeft'].includes(e.code)) doShoot(); if(e.code==='KeyR') location.reload(); };
window.onkeyup = e => keys[e.code] = false;
document.getElementById('btnR').onclick = () => location.reload();

const bind = (id, k, move) => {
    const el = document.getElementById(id);
    el.addEventListener('touchstart', (e) => { e.preventDefault(); startBGM(); if(move) touch[k]=true; else (id==='btnJump'?doJump():doShoot()); }, {passive: false});
    el.addEventListener('touchend', (e) => { e.preventDefault(); if(move) touch[k]=false; }, {passive: false});
};
bind('btnL','L',true); bind('btnRight','R',true); bind('btnJump','',false); bind('btnShoot','',false);

function update(time) {
    const dt = (time - lastTime) / 16.67 || 1; 
    lastTime = time;

    if(invuln > 0) invuln -= dt;

    if(!isWin) {
        if(keys.ArrowRight||keys.KeyD||touch.R) { p.vx = Math.min(p.vx + 1.5*dt, 10); p.face=1; }
        else if(keys.ArrowLeft||keys.KeyA||touch.L) { p.vx = Math.max(p.vx - 1.5*dt, -10); p.face=-1; }
        else p.vx *= Math.pow(0.82, dt);

        p.vy += 0.55 * dt; p.x += p.vx * dt; p.y += p.vy * dt;
        if(castlePos.x - p.x < 800) gateOpen = Math.min(gateOpen + 0.02 * dt, 1);

        platforms.forEach(plat => {
            if(p.x < plat.x + plat.w && p.x + p.w > plat.x && p.y < plat.y + plat.h && p.y + p.h > plat.y) {
                let ox = Math.min(p.x+p.w-plat.x, plat.x+plat.w-p.x), oy = Math.min(p.y+p.h-plat.y, plat.y+plat.h-p.y);
                if(ox > oy) {
                    if(p.vy > 0 && p.y < plat.y) { p.jumps=0; p.vy=0; p.y=plat.y-p.h; }
                    else if(p.vy < 0) { p.vy=0; p.y=plat.y+plat.h; }
                } else { p.x = (p.x < plat.x) ? plat.x-p.w : plat.x+plat.w; p.vx=0; }
            }
        });

        enemies.forEach((en, i) => {
            en.x += en.vx * dt; if(Math.abs(en.x-en.start)>en.range) en.vx*=-1;
            if(p.x<en.x+en.w && p.x+p.w>en.x && p.y<en.y+en.h && p.y+p.h>en.y && invuln<=0) {
                hp -= 34; invuln = 60; document.getElementById('health-fill').style.width = hp+'%';
                if(hp <= 0) location.reload();
            }
            bullets.forEach((b, bi) => {
                if(b.x>en.x && b.x<en.x+en.w && b.y>en.y && b.y<en.y+en.h) {
                    sndHit.currentTime = 0; sndHit.play().catch(()=>{});
                    enemies.splice(i, 1); bullets.splice(bi, 1); score+=200;
                    document.getElementById('score').innerText = score.toString().padStart(4,'0');
                }
            });
        });

        if(p.x > finishLine) { isWin=true; document.getElementById('msg').style.display='block'; }
    } else { if(Math.random() < 0.25) createConfetti(p.x + Math.random()*400-200, p.y-100); }

    bullets.forEach((b, i) => { b.x += b.vx * dt; b.life -= dt; if(b.life<=0) bullets.splice(i,1); });
    confetti.forEach((c, i) => { c.x += c.vx*dt; c.y += c.vy*dt; c.vy += 0.4*dt; c.life-=dt; if(c.life<=0) confetti.splice(i,1); });

    camX += (p.x - canvas.width/3 - camX) * 0.1 * dt;
    draw();
    requestAnimationFrame(update);
}

function draw() {
    ctx.clearRect(0,0,canvas.width,canvas.height);
    let sky = Math.min(p.x/finishLine, 1);
    ctx.fillStyle = `rgb(${92-70*sky}, ${148-130*sky}, ${250-200*sky})`;
    ctx.fillRect(0,0,canvas.width,canvas.height);

    ctx.save(); ctx.translate(-camX, 0);
    if(castleImg.complete) {
        ctx.drawImage(castleImg, castlePos.x, castlePos.y, castlePos.w, castlePos.h);
        ctx.fillStyle = "rgba(0,0,0,0.7)";
        ctx.fillRect(castlePos.x+castlePos.w/2-50-(gateOpen*40), castlePos.y+castlePos.h-140, 50, 120);
        ctx.fillRect(castlePos.x+castlePos.w/2+(gateOpen*40), castlePos.y+castlePos.h-140, 50, 120);
    }
    ctx.fillStyle = "#5d4037"; platforms.forEach(plat => ctx.fillRect(plat.x, plat.y, plat.w, plat.h));
    enemies.forEach(en => { if(en.img.complete) ctx.drawImage(en.img, en.x, en.y, en.w, en.h); });
    ctx.fillStyle = "#0ff"; bullets.forEach(b => { ctx.beginPath(); ctx.arc(b.x, b.y, 14, 0, Math.PI*2); ctx.fill(); });
    confetti.forEach(c => { ctx.fillStyle=c.color; ctx.fillRect(c.x, c.y, c.size, c.size); });

    if(!(invuln%4 > 2) && mariaImg.complete) {
        ctx.save();
        if(p.face===-1) { ctx.translate(p.x+p.w, p.y); ctx.scale(-1,1); ctx.drawImage(mariaImg,0,0,p.w,p.h); }
        else ctx.drawImage(mariaImg, p.x, p.y, p.w, p.h);
        ctx.restore();
    }
    ctx.restore();
}
requestAnimationFrame(update);
</script>
</body>
</html>
