<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Maria's Quest: Master Build</title>
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        html, body { position: fixed; width: 100%; height: 100%; overflow: hidden; background: #000; margin: 0; padding: 0; }
        #game-container { position: relative; width: 100vw; height: 100vh; display: flex; align-items: center; justify-content: center; }
        canvas { display: block; background: #1a1a2e; max-width: 100%; max-height: 100%; object-fit: contain; }

        /* UI */
        #ui { position: absolute; top: 10px; left: 10px; z-index: 100; pointer-events: none; }
        .stats { background: rgba(0,0,0,0.8); padding: 8px 12px; border: 2px solid #00ffff; border-radius: 8px; color: #ffff00; font-size: 16px; font-weight: bold; }
        #health-bar { width: 120px; height: 10px; background: #333; border: 1px solid #fff; border-radius: 5px; margin-top: 4px; overflow: hidden; }
        #health-fill { width: 100%; height: 100%; background: #ff0000; transition: width 0.2s; }
        
        #top-btns { position: absolute; top: 10px; right: 10px; display: flex; gap: 10px; z-index: 110; }
        .small-btn { width: 45px; height: 45px; background: rgba(255,255,255,0.2); border: 2px solid #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; cursor: pointer; pointer-events: auto; font-size: 12px; }

        #msg { position: absolute; top: 35%; left: 50%; transform: translate(-50%, -50%); font-size: 28px; text-align: center; display: none; background: rgba(0,0,0,0.9); padding: 20px; border: 4px solid #ff00ff; color: #00ffff; border-radius: 15px; z-index: 120; width: 70%; }

        /* MOBILE CONTROLS */
        .controls { position: absolute; bottom: 8%; width: 100%; display: flex; justify-content: space-between; padding: 0 20px; z-index: 100; pointer-events: none; }
        .btn-group { display: flex; gap: 15px; pointer-events: none; }
        .btn { width: 75px; height: 75px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; border: 3px solid rgba(255,255,255,0.7); pointer-events: auto; font-weight: bold; font-size: 14px; }
        .btn-fire { background: rgba(255, 0, 0, 0.4); border-color: #ff4444; }
        .btn:active { background: rgba(255,255,255,0.5); transform: scale(0.9); }

        @media (min-width: 1024px) { .controls { display: none; } }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="ui">
            <div class="stats">SCORE: <span id="score">0000</span></div>
            <div id="health-bar"><div id="health-fill"></div></div>
        </div>
        <div id="top-btns">
            <div id="btnMute" class="small-btn">MUTE</div>
            <div id="btnR" class="small-btn">R</div>
        </div>
        <div id="msg">HAPPY BIRTHDAY MARIA!</div>
        <div class="controls">
            <div class="btn-group">
                <div id="btnL" class="btn">LEFT</div>
                <div id="btnRight" class="btn">RIGHT</div>
            </div>
            <div class="btn-group">
                <div id="btnShoot" class="btn btn-fire">FIRE</div>
                <div id="btnJump" class="btn">JUMP</div>
            </div>
        </div>
        <canvas id="gameCanvas"></canvas>
    </div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
canvas.width = 1200; canvas.height = 700;

// --- ASSETS ---
const mariaImg = new Image(); mariaImg.src = 'Gemini_Generated_Image_b9w7vcb9w7vcb9w7-removebg-preview.png';
const zombieImg = new Image(); zombieImg.src = 'zombie.png';
const frankImg = new Image(); frankImg.src = 'frank.png';
const castleImg = new Image(); castleImg.src = 'castle.png';

const sndShoot = new Audio('shoot.mp3');
const sndHit = new Audio('hit.mp3');
const sndBGM = new Audio('bgm.mp3'); sndBGM.loop = true;

// --- STATE ---
let score = 0, hp = 100, camX = 0, isWin = false, invuln = 0, lastTime = performance.now();
let bullets = [], particles = [], confetti = [], keys = {}, touch = {L:false, R:false}, isMuted = false;
let gateOpen = 0;

const p = { x: 100, y: 300, w: 110, h: 170, vx: 0, vy: 0, jumps: 0, face: 1 };
const platforms = [
    { x: 0, y: 620, w: 12000, h: 80 },
    { x: 1400, y: 200, w: 120, h: 500, wall: true },
    { x: 2800, y: 350, w: 700, h: 40 }
];
const enemies = [
    { x: 1000, y: 460, w: 100, h: 160, vx: 3, img: zombieImg, start: 1000, range: 400 },
    { x: 2500, y: 460, w: 110, h: 160, vx: 2, img: frankImg, start: 2500, range: 300 },
    { x: 5000, y: 460, w: 100, h: 160, vx: 5, img: zombieImg, start: 5000, range: 600 },
    { x: 8000, y: 460, w: 110, h: 160, vx: 3, img: frankImg, start: 7800, range: 600 }
];
const castlePos = { x: 10000, y: 20, w: 500, h: 600 };
const finishLine = 10100;

// --- FUNCTIONS ---
function toggleMute() {
    isMuted = !isMuted;
    sndBGM.muted = sndShoot.muted = sndHit.muted = isMuted;
    document.getElementById('btnMute').innerText = isMuted ? "UNMUTE" : "MUTE";
}

function startBGM() { if(sndBGM.paused && !isMuted) sndBGM.play().catch(()=>{}); }

function doJump() { if(p.jumps < 2) { p.vy = -18; p.jumps++; startBGM(); } }

function doShoot() { 
    if(isWin) return;
    bullets.push({x: p.x+(p.face===1?p.w:0), y: p.y+60, vx: p.face*25, life: 80});
    sndShoot.currentTime = 0; sndShoot.play().catch(()=>{}); 
}

// --- INPUTS (FIXED PC BUG) ---
window.onkeydown = e => { 
    keys[e.code] = true; startBGM();
    if(['Space','ArrowUp','KeyW'].includes(e.code)) { e.preventDefault(); doJump(); }
    if(['KeyF','KeyK','ShiftLeft'].includes(e.code)) doShoot();
};
window.onkeyup = e => { keys[e.code] = false; };

document.getElementById('btnR').onclick = () => location.reload();
document.getElementById('btnMute').onclick = toggleMute;

const bind = (id, k, move) => {
    const el = document.getElementById(id);
    el.addEventListener('touchstart', (e) => { e.preventDefault(); if(move) touch[k]=true; else (id==='btnJump'?doJump():doShoot()); }, {passive: false});
    el.addEventListener('touchend', (e) => { e.preventDefault(); if(move) touch[k]=false; }, {passive: false});
};
bind('btnL','L',true); bind('btnRight','R',true); bind('btnJump','',false); bind('btnShoot','',false);

// --- MAIN LOOP ---
function update(time) {
    const dt = (time - lastTime) / 16.67 || 1; lastTime = time;
    if(invuln > 0) invuln -= dt;

    if(!isWin) {
        // Unified Movement Check
        const moveR = keys.ArrowRight || keys.KeyD || touch.R;
        const moveL = keys.ArrowLeft || keys.KeyA || touch.L;

        if(moveR) { p.vx = Math.min(p.vx + 1.6*dt, 10); p.face=1; }
        else if(moveL) { p.vx = Math.max(p.vx - 1.6*dt, -10); p.face=-1; }
        else p.vx *= Math.pow(0.8, dt);

        p.vy += 0.6*dt; p.x += p.vx*dt; p.y += p.vy*dt;
        if(castlePos.x - p.x < 800) gateOpen = Math.min(gateOpen+0.02*dt, 1);

        platforms.forEach(plat => {
            if(p.x < plat.x + plat.w && p.x + p.w > plat.x && p.y < plat.y + plat.h && p.y + p.h > plat.y) {
                let ox = Math.min(p.x+p.w-plat.x, plat.x+plat.w-p.x), oy = Math.min(p.y+p.h-plat.y, plat.y+plat.h-p.y);
                if(ox > oy) {
                    if(p.vy > 0 && p.y < plat.y) { p.jumps=0; p.vy=0; p.y=plat.y-p.h; }
                    else if(p.vy < 0) { p.vy=0; p.y=plat.y+plat.h; }
                } else { p.x = (p.x < plat.x) ? plat.x-p.w : plat.x+plat.w; p.vx=0; }
            }
        });

        enemies.forEach((en, i) => {
            en.x += en.vx*dt; if(Math.abs(en.x-en.start)>en.range) en.vx*=-1;
            if(p.x<en.x+en.w && p.x+p.w>en.x && p.y<en.y+en.h && p.y+p.h>en.y && invuln<=0) {
                hp-=34; invuln=60; document.getElementById('health-fill').style.width = hp+'%';
                if(hp<=0) location.reload();
            }
            bullets.forEach((b, bi) => {
                if(b.x>en.x && b.x<en.x+en.w && b.y>en.y && b.y<en.y+en.h) {
                    sndHit.currentTime=0; sndHit.play().catch(()=>{});
                    enemies.splice(i, 1); bullets.splice(bi, 1); score+=200;
                    document.getElementById('score').innerText = score.toString().padStart(4,'0');
                }
            });
        });
        if(p.x > finishLine) { isWin=true; document.getElementById('msg').style.display='block'; }
    } else {
        if(Math.random()<0.2) confetti.push({x:p.x+Math.random()*200-100, y:p.y, vx:(Math.random()-0.5)*10, vy:(Math.random()-1)*10, size:Math.random()*6+2, color:`hsl(${Math.random()*360},100%,50%)`, life:100});
    }

    bullets.forEach((b, i) => { b.x += b.vx*dt; b.life-=dt; if(b.life<=0) bullets.splice(i,1); });
    confetti.forEach((c, i) => { c.x+=c.vx*dt; c.y+=c.vy*dt; c.vy+=0.3*dt; c.life-=dt; if(c.life<=0) confetti.splice(i,1); });

    camX += (p.x - canvas.width/4 - camX) * 0.1 * dt;
    draw();
    requestAnimationFrame(update);
}

function draw() {
    ctx.clearRect(0,0,canvas.width,canvas.height);
    let sky = Math.min(p.x/finishLine, 1);
    ctx.fillStyle = `rgb(${40-20*sky}, ${80-60*sky}, ${150-100*sky})`;
    ctx.fillRect(0,0,canvas.width,canvas.height);

    ctx.save(); ctx.translate(-camX, 0);
    if(castleImg.complete) {
        ctx.drawImage(castleImg, castlePos.x, castlePos.y, castlePos.w, castlePos.h);
        ctx.fillStyle = "black";
        ctx.fillRect(castlePos.x+castlePos.w/2-40-(gateOpen*30), castlePos.y+castlePos.h-120, 40, 100);
        ctx.fillRect(castlePos.x+castlePos.w/2+(gateOpen*30), castlePos.y+castlePos.h-120, 40, 100);
    }
    ctx.fillStyle = "#332211"; platforms.forEach(plat => ctx.fillRect(plat.x, plat.y, plat.w, plat.h));
    enemies.forEach(en => { if(en.img.complete) ctx.drawImage(en.img, en.x, en.y, en.w, en.h); });
    ctx.fillStyle = "#0ff"; bullets.forEach(b => ctx.fillRect(b.x, b.y, 25, 8));
    confetti.forEach(c => { ctx.fillStyle=c.color; ctx.fillRect(c.x, c.y, c.size, c.size); });

    if(!(invuln%4 > 2) && mariaImg.complete) {
        ctx.save();
        if(p.face===-1) { ctx.translate(p.x+p.w, p.y); ctx.scale(-1,1); ctx.drawImage(mariaImg,0,0,p.w,p.h); }
        else ctx.drawImage(mariaImg, p.x, p.y, p.w, p.h);
        ctx.restore();
    }
    ctx.restore();
}
requestAnimationFrame(update);
</script>
</body>
</html>
