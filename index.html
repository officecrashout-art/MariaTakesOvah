<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Maria's Birthday Quest - Castle Edition</title>
    <style>
        body { margin: 0; overflow: hidden; background: #1a1a2e; font-family: sans-serif; touch-action: none; }
        canvas { display: block; }
        #ui { position: absolute; top: 15px; left: 15px; z-index: 10; pointer-events: none; }
        .stats { background: rgba(0,0,0,0.8); padding: 12px; border: 2px solid #00ffff; border-radius: 8px; color: #ffff00; font-size: 22px; font-weight: bold; }
        #health-bar { width: 200px; height: 18px; background: #333; border: 2px solid #fff; border-radius: 10px; margin-top: 5px; overflow: hidden; }
        #health-fill { width: 100%; height: 100%; background: #ff0000; transition: width 0.2s; }
        #btnR { position: absolute; top: 15px; right: 15px; width: 60px; height: 60px; background: rgba(255,255,255,0.2); border: 3px solid #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 28px; z-index: 30; cursor: pointer; }
        #msg { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 45px; text-align: center; display: none; background: rgba(0,0,0,0.9); padding: 50px; border: 8px solid #ff00ff; color: #00ffff; border-radius: 20px; z-index: 20; }
        .controls { position: absolute; bottom: 30px; width: 100%; display: flex; justify-content: space-between; padding: 0 30px; box-sizing: border-box; }
        .btn { width: 85px; height: 85px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; border: 3px solid #fff; user-select: none; }
        .btn-fire { background: rgba(255, 0, 0, 0.4); }
    </style>
</head>
<body>
    <div id="ui"><div class="stats">SCORE: <span id="score">0000</span></div><div id="health-bar"><div id="health-fill"></div></div></div>
    <div id="btnR">R</div>
    <div id="msg">HAPPY BIRTHDAY MARIA!</div>
    <div class="controls">
        <div style="display:flex; gap:20px;"><div id="btnL" class="btn">←</div><div id="btnRight" class="btn">→</div></div>
        <div style="display:flex; gap:20px;"><div id="btnShoot" class="btn btn-fire">FIRE</div><div id="btnJump" class="btn">JUMP</div></div>
    </div>
    <canvas id="gameCanvas"></canvas>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
window.onresize = resize; resize();

// --- AUDIO ---
const sndShoot = new Audio('shoot.mp3');
const sndHit = new Audio('hit.mp3');
const sndBGM = new Audio('bgm.mp3');
sndBGM.loop = true;
let bgmStarted = false;

function startAudio() {
    if (!bgmStarted) {
        sndBGM.play().catch(() => {});
        bgmStarted = true;
    }
}

// --- IMAGES ---
const mariaImg = new Image(); mariaImg.src = 'Gemini_Generated_Image_b9w7vcb9w7vcb9w7-removebg-preview.png';
const zombieImg = new Image(); zombieImg.src = 'zombie.png';
const frankImg = new Image(); frankImg.src = 'frank.png';
const castleImg = new Image(); castleImg.src = 'castle.png';

// --- STATE ---
let score = 0, hp = 100, camX = 0, isWin = false, invuln = 0, lastTime = 0;
let bullets = [], particles = [], keys = {}, touch = {L:false, R:false};

const p = { x: 150, y: 100, w: 140, h: 210, vx: 0, vy: 0, jumps: 0, face: 1 };
const platforms = [
    { x: 0, y: canvas.height - 80, w: 12000, h: 100 },
    { x: 1400, y: canvas.height - 500, w: 120, h: 500, wall: true },
    { x: 2800, y: canvas.height - 350, w: 700, h: 40 },
    { x: 5000, y: canvas.height - 400, w: 1000, h: 40 }
];

const enemies = [
    { x: 800, y: canvas.height - 240, w: 110, h: 160, vx: 3, img: zombieImg, start: 800, range: 300 },
    { x: 1200, y: canvas.height - 240, w: 120, h: 160, vx: 2, img: frankImg, start: 1200, range: 200 },
    { x: 2500, y: canvas.height - 240, w: 120, h: 160, vx: 2, img: frankImg, start: 2000, range: 250 },
    { x: 4500, y: canvas.height - 240, w: 110, h: 160, vx: 5, img: zombieImg, start: 4500, range: 500 },
    { x: 6500, y: canvas.height - 240, w: 110, h: 160, vx: 6, img: zombieImg, start: 6500, range: 300 },
    { x: 8000, y: canvas.height - 240, w: 120, h: 160, vx: 3, img: frankImg, start: 7800, range: 600 }
];
const finishLine = 10000;
const castle = { x: 10000, y: canvas.height - 680, w: 600, h: 600 };

// --- INPUTS ---
window.onkeydown = e => { 
    startAudio();
    keys[e.code] = true; 
    if(['Space','ArrowUp','KeyW'].includes(e.code)) doJump(); 
    if(['KeyF','KeyK','ShiftLeft'].includes(e.code)) doShoot();
    if(e.code === 'KeyR') location.reload();
};
window.onkeyup = e => keys[e.code] = false;
document.getElementById('btnR').onclick = () => location.reload();

function doJump() { if(p.jumps < 2) { p.vy = -19; p.jumps++; } }
function doShoot() { 
    if(isWin) return;
    bullets.push({x: p.x + (p.face===1?p.w:0), y: p.y + 80, vx: p.face*25, life: 80});
    sndShoot.currentTime = 0; sndShoot.play().catch(()=>{}); 
}

const bind = (id, k, move) => {
    const el = document.getElementById(id);
    el.ontouchstart = (e) => { 
        e.preventDefault(); startAudio();
        if(move) touch[k]=true; else (id==='btnJump'?doJump():doShoot()); 
    };
    el.ontouchend = (e) => { e.preventDefault(); if(move) touch[k]=false; };
};
bind('btnL','L',true); bind('btnRight','R',true); bind('btnJump','',false); bind('btnShoot','',false);

function update(time) {
    const dt = (time - lastTime) / 16.67 || 1; 
    lastTime = time;

    if(isWin) { draw(); requestAnimationFrame(update); return; }
    if(invuln > 0) invuln -= dt;

    let speedMult = 1.6 * dt;
    if(keys.ArrowRight||keys.KeyD||touch.R) { p.vx = Math.min(p.vx + speedMult, 11); p.face=1; }
    else if(keys.ArrowLeft||keys.KeyA||touch.L) { p.vx = Math.max(p.vx - speedMult, -11); p.face=-1; }
    else p.vx *= Math.pow(0.82, dt);

    p.vy += 0.55 * dt; p.x += p.vx * dt; p.y += p.vy * dt;

    platforms.forEach(plat => {
        if(p.x < plat.x + plat.w && p.x + p.w > plat.x && p.y < plat.y + plat.h && p.y + p.h > plat.y) {
            let ox = Math.min(p.x+p.w-plat.x, plat.x+plat.w-p.x);
            let oy = Math.min(p.y+p.h-plat.y, plat.y+plat.h-p.y);
            if(ox > oy) {
                if(p.vy > 0 && p.y < plat.y) { p.jumps=0; p.vy=0; p.y=plat.y-p.h; }
                else if(p.vy < 0) { p.vy=0; p.y=plat.y+plat.h; }
            } else { p.x = (p.x < plat.x) ? plat.x-p.w : plat.x+plat.w; p.vx=0; }
        }
    });

    enemies.forEach((en, i) => {
        en.x += en.vx * dt; if(Math.abs(en.x-en.start)>en.range) en.vx*=-1;
        if(p.x<en.x+en.w && p.x+p.w>en.x && p.y<en.y+en.h && p.y+p.h>en.y && invuln<=0) {
            hp -= 34; invuln = 60; document.getElementById('health-fill').style.width = hp+'%';
            if(hp <= 0) location.reload();
        }
        bullets.forEach((b, bi) => {
            if(b.x>en.x && b.x<en.x+en.w && b.y>en.y && b.y<en.y+en.h) {
                sndHit.currentTime = 0; sndHit.play().catch(()=>{});
                for(let j=0; j<15; j++) particles.push({x:en.x+en.w/2, y:en.y+en.h/2, vx:(Math.random()-0.5)*20, vy:(Math.random()-0.5)*20, life:50});
                enemies.splice(i, 1); bullets.splice(bi, 1); score+=200;
                document.getElementById('score').innerText = score.toString().padStart(4,'0');
            }
        });
    });

    bullets.forEach((b, i) => { b.x += b.vx * dt; b.life -= dt; if(b.life<=0) bullets.splice(i,1); });
    particles.forEach((pt, i) => { pt.x += pt.vx*dt; pt.y += pt.vy*dt; pt.life -= dt; if(pt.life<=0) particles.splice(i,1); });

    if(p.x > finishLine) { isWin=true; document.getElementById('msg').style.display='block'; }
    camX += (p.x - canvas.width/3 - camX) * 0.1 * dt;
    draw();
    requestAnimationFrame(update);
}

function draw() {
    ctx.clearRect(0,0,canvas.width,canvas.height);
    let sky = Math.min(p.x/finishLine, 1);
    ctx.fillStyle = `rgb(${92-70*sky}, ${148-130*sky}, ${250-200*sky})`;
    ctx.fillRect(0,0,canvas.width,canvas.height);

    ctx.save(); ctx.translate(-camX, 0);
    
    // Castle
    if(castleImg.complete) ctx.drawImage(castleImg, castle.x, castle.y, castle.w, castle.h);
    else { ctx.fillStyle = "#ff00ff"; ctx.fillRect(finishLine, canvas.height-400, 150, 400); }

    ctx.fillStyle = "#5d4037"; platforms.forEach(plat => ctx.fillRect(plat.x, plat.y, plat.w, plat.h));
    enemies.forEach(en => { if(en.img.complete) ctx.drawImage(en.img, en.x, en.y, en.w, en.h); });
    ctx.fillStyle = "#0ff"; bullets.forEach(b => { ctx.beginPath(); ctx.arc(b.x, b.y, 14, 0, Math.PI*2); ctx.fill(); });
    particles.forEach(pt => { ctx.fillStyle=`hsl(${Math.random()*360},100%,50%)`; ctx.fillRect(pt.x, pt.y, 8, 8); });

    if(!(invuln%4 > 2) && mariaImg.complete) {
        ctx.save();
        if(p.face===-1) { ctx.translate(p.x+p.w, p.y); ctx.scale(-1,1); ctx.drawImage(mariaImg,0,0,p.w,p.h); }
        else ctx.drawImage(mariaImg, p.x, p.y, p.w, p.h);
        ctx.restore();
    }
    ctx.restore();
}
requestAnimationFrame(update);
</script>
</body>
</html>