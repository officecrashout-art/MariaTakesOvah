<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Maria's Quest: Progress & Action</title>
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        html, body { position: fixed; width: 100%; height: 100%; overflow: hidden; background: #000; margin: 0; padding: 0; }
        #game-container { position: relative; width: 100vw; height: 100vh; display: flex; align-items: center; justify-content: center; }
        canvas { display: block; background: #1a1a2e; max-width: 100%; max-height: 100%; object-fit: contain; }

        /* UI */
        #ui-left { position: absolute; top: 15px; left: 15px; z-index: 100; pointer-events: none; }
        .stats { background: rgba(0,0,0,0.8); padding: 10px 15px; border: 2px solid #00ffff; border-radius: 8px; color: #ffff00; font-size: 18px; font-weight: bold; }
        #health-bar { width: 140px; height: 12px; background: #333; border: 1px solid #fff; border-radius: 6px; margin-top: 5px; overflow: hidden; }
        #health-fill { width: 100%; height: 100%; background: #ff0000; transition: width 0.2s; }

        /* PROGRESS BAR */
        #progress-container { position: absolute; top: 15px; left: 50%; transform: translateX(-50%); width: 250px; text-align: center; z-index: 100; pointer-events: none; }
        #progress-bg { width: 100%; height: 10px; background: rgba(255,255,255,0.2); border: 1px solid #fff; border-radius: 5px; overflow: hidden; }
        #progress-fill { width: 0%; height: 100%; background: linear-gradient(90deg, #ff00ff, #00ffff); }
        #progress-text { color: white; font-size: 12px; font-weight: bold; margin-top: 4px; text-shadow: 1px 1px #000; }
        
        #top-btns { position: absolute; top: 15px; right: 15px; display: flex; gap: 10px; z-index: 110; }
        .small-btn { width: 50px; height: 50px; background: rgba(255,255,255,0.2); border: 2px solid #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; cursor: pointer; pointer-events: auto; font-size: 11px; }

        #msg { position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%); font-size: 32px; text-align: center; display: none; background: rgba(0,0,0,0.9); padding: 30px; border: 5px solid #ff00ff; color: #00ffff; border-radius: 15px; z-index: 120; width: 80%; }

        /* CONTROLS */
        .controls { position: absolute; bottom: 40px; width: 100%; display: flex; justify-content: space-between; padding: 0 25px; z-index: 100; pointer-events: none; }
        .btn-group { display: flex; gap: 20px; pointer-events: none; }
        .btn { width: 80px; height: 80px; background: rgba(255,255,255,0.15); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; border: 3px solid rgba(255,255,255,0.6); pointer-events: auto; font-weight: bold; font-size: 14px; }
        .btn-fire { background: rgba(255, 0, 0, 0.3); border-color: #ff4444; }
        .btn:active { background: rgba(255,255,255,0.4); transform: scale(0.9); }

        @media (min-width: 1024px) { .controls { display: none; } }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="ui-left">
            <div class="stats">SCORE: <span id="score">0000</span></div>
            <div id="health-bar"><div id="health-fill"></div></div>
        </div>
        <div id="progress-container">
            <div id="progress-bg"><div id="progress-fill"></div></div>
            <div id="progress-text">CASTLE DISTANCE</div>
        </div>
        <div id="top-btns">
            <div id="btnMute" class="small-btn">SOUND</div>
            <div id="btnR" class="small-btn">RESTART</div>
        </div>
        <div id="msg">HAPPY BIRTHDAY MARIA!</div>
        <div class="controls">
            <div class="btn-group">
                <div id="btnL" class="btn">LEFT</div>
                <div id="btnRight" class="btn">RIGHT</div>
            </div>
            <div class="btn-group">
                <div id="btnShoot" class="btn btn-fire">FIRE</div>
                <div id="btnJump" class="btn">JUMP</div>
            </div>
        </div>
        <canvas id="gameCanvas"></canvas>
    </div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
canvas.width = 1200; canvas.height = 700;

// --- ASSETS ---
const mariaImg = new Image(); mariaImg.src = 'Gemini_Generated_Image_b9w7vcb9w7vcb9w7-removebg-preview.png';
const zombieImg = new Image(); zombieImg.src = 'zombie.png';
const frankImg = new Image(); frankImg.src = 'frank.png';
const castleImg = new Image(); castleImg.src = 'castle.png';

const sndShoot = new Audio('shoot.mp3');
const sndHit = new Audio('hit.mp3');
const sndBGM = new Audio('bgm.mp3'); sndBGM.loop = true;

// --- STATE ---
let score = 0, hp = 100, camX = 0, isWin = false, invuln = 0, lastTime = performance.now();
let bullets = [], particles = [], confetti = [], keys = {}, touch = {L:false, R:false}, isMuted = false;
let gateOpen = 0, bgmOn = false;

// Clouds (Parallax)
const clouds = [];
for(let i=0; i<15; i++) {
    clouds.push({ x: Math.random() * 12000, y: Math.random() * 250, speed: 0.2 + Math.random() * 0.5, w: 100 + Math.random() * 100 });
}

const p = { x: 150, y: 100, w: 110, h: 170, vx: 0, vy: 0, jumps: 0, face: 1 };
const platforms = [
    { x: 0, y: 620, w: 12000, h: 80 },
    { x: 1400, y: 250, w: 120, h: 450, wall: true },
    { x: 2800, y: 350, w: 700, h: 40 },
    { x: 5000, y: 300, w: 800, h: 40 },
    { x: 7200, y: 350, w: 500, h: 40 }
];

// CRANKED UP VILLAIN COUNT
const enemies = [
    { x: 800, y: 460, w: 100, h: 160, vx: 3, img: zombieImg, start: 800, range: 300 },
    { x: 1200, y: 460, w: 110, h: 160, vx: 2, img: frankImg, start: 1200, range: 200 },
    { x: 2100, y: 460, w: 100, h: 160, vx: 4, img: zombieImg, start: 2100, range: 400 },
    { x: 2900, y: 190, w: 110, h: 160, vx: 3, img: frankImg, start: 2850, range: 200 }, // Enemy on platform
    { x: 4000, y: 460, w: 100, h: 160, vx: 5, img: zombieImg, start: 4000, range: 500 },
    { x: 5100, y: 140, w: 110, h: 160, vx: 4, img: frankImg, start: 5050, range: 300 }, // Enemy on high platform
    { x: 6200, y: 460, w: 100, h: 160, vx: 3, img: zombieImg, start: 6200, range: 400 },
    { x: 7300, y: 190, w: 110, h: 160, vx: 4, img: frankImg, start: 7250, range: 250 },
    { x: 8500, y: 460, w: 100, h: 160, vx: 6, img: zombieImg, start: 8500, range: 300 },
    { x: 9200, y: 460, w: 110, h: 160, vx: 5, img: frankImg, start: 9200, range: 400 }
];
const castlePos = { x: 11000, y: 20, w: 500, h: 600 };
const finishLine = 11100;

// --- ACTIONS ---
function toggleMute() {
    isMuted = !isMuted;
    sndBGM.muted = sndShoot.muted = sndHit.muted = isMuted;
    document.getElementById('btnMute').innerText = isMuted ? "OFF" : "SOUND";
}
function startBGM() { if(!bgmOn && !isMuted) { sndBGM.play().catch(()=>{}); bgmOn = true; } }
function doJump() { if(p.jumps < 2) { p.vy = -18; p.jumps++; startBGM(); } }
function doShoot() { 
    if(isWin) return;
    bullets.push({x: p.x+(p.face===1?p.w:0), y: p.y+65, vx: p.face*25, life: 80});
    sndShoot.currentTime = 0; sndShoot.play().catch(()=>{}); startBGM();
}

// --- INPUTS ---
window.onkeydown = e => { keys[e.code] = true; if(['Space','ArrowUp','KeyW'].includes(e.code)) { e.preventDefault(); doJump(); } if(['KeyF','KeyK','ShiftLeft'].includes(e.code)) doShoot(); };
window.onkeyup = e => keys[e.code] = false;
document.getElementById('btnR').onclick = () => location.reload();
document.getElementById('btnMute').onclick = toggleMute;

const bind = (id, k, move) => {
    const el = document.getElementById(id);
    el.addEventListener('touchstart', (e) => { e.preventDefault(); if(move) touch[k]=true; else (id==='btnJump'?doJump():doShoot()); }, {passive: false});
    el.addEventListener('touchend', (e) => { e.preventDefault(); if(move) touch[k]=false; }, {passive: false});
};
bind('btnL','L',true); bind('btnRight','R',true); bind('btnJump','',false); bind('btnShoot','',false);

function update(time) {
    const dt = (time - lastTime) / 16.67 || 1; lastTime = time;
    if(invuln > 0) invuln -= dt;

    if(!isWin) {
        const moveR = keys.ArrowRight || keys.KeyD || touch.R;
        const moveL = keys.ArrowLeft || keys.KeyA || touch.L;
        if(moveR) { p.vx = Math.min(p.vx + 1.5*dt, 10); p.face=1; }
        else if(moveL) { p.vx = Math.max(p.vx - 1.5*dt, -10); p.face=-1; }
        else p.vx *= Math.pow(0.82, dt);

        p.vy += 0.55*dt; p.x += p.vx*dt; p.y += p.vy*dt;
        if(castlePos.x - p.x < 800) gateOpen = Math.min(gateOpen+0.02*dt, 1);

        // Progress Bar Calculation
        let prog = Math.min((p.x / finishLine) * 100, 100);
        document.getElementById('progress-fill').style.width = prog + '%';

        platforms.forEach(plat => {
            if(p.x < plat.x + plat.w && p.x + p.w > plat.x && p.y < plat.y + plat.h && p.y + p.h > plat.y) {
                let ox = Math.min(p.x+p.w-plat.x, plat.x+plat.w-p.x), oy = Math.min(p.y+p.h-plat.y, plat.y+plat.h-p.y);
                if(ox > oy) {
                    if(p.vy > 0 && p.y < plat.y) { p.jumps=0; p.vy=0; p.y=plat.y-p.h; }
                    else if(p.vy < 0) { p.vy=0; p.y=plat.y+plat.h; }
                } else { p.x = (p.x < plat.x) ? plat.x-p.w : plat.x+plat.w; p.vx=0; }
            }
        });

        enemies.forEach((en, i) => {
            en.x += en.vx*dt; if(Math.abs(en.x-en.start)>en.range) en.vx*=-1;
            if(p.x<en.x+en.w && p.x+p.w>en.x && p.y<en.y+en.h && p.y+p.h>en.y && invuln<=0) {
                hp-=34; invuln=60; document.getElementById('health-fill').style.width = hp+'%';
                if(hp<=0) location.reload();
            }
            bullets.forEach((b, bi) => {
                if(b.x>en.x && b.x<en.x+en.w && b.y>en.y && b.y<en.y+en.h) {
                    sndHit.currentTime=0; sndHit.play().catch(()=>{});
                    enemies.splice(i, 1); bullets.splice(bi, 1); score+=200;
                    document.getElementById('score').innerText = score.toString().padStart(4,'0');
                }
            });
        });
        if(p.x > finishLine) { isWin=true; document.getElementById('msg').style.display='block'; }
    } else {
        if(Math.random()<0.3) confetti.push({x:p.x+Math.random()*200-100, y:p.y-100, vx:(Math.random()-0.5)*15, vy:(Math.random()-1.2)*15, size:Math.random()*8+4, color:`hsl(${Math.random()*360},100%,50%)`, life:100});
    }

    bullets.forEach((b, i) => { b.x += b.vx*dt; b.life-=dt; if(b.life<=0) bullets.splice(i,1); });
    confetti.forEach((c, i) => { c.x+=c.vx*dt; c.y+=c.vy*dt; c.vy+=0.4*dt; c.life-=dt; if(c.life<=0) confetti.splice(i,1); });

    camX += (p.x - canvas.width/4 - camX) * 0.1 * dt;
    draw();
    requestAnimationFrame(update);
}

function draw() {
    ctx.clearRect(0,0,canvas.width,canvas.height);
    
    // Dynamic Sky
    let skyProg = Math.min(p.x / finishLine, 1);
    let r = Math.floor(135 - skyProg * 115); 
    let g = Math.floor(206 - skyProg * 196); 
    let b = Math.floor(235 - skyProg * 185); 
    ctx.fillStyle = `rgb(${r}, ${g}, ${b})`;
    ctx.fillRect(0,0,canvas.width,canvas.height);

    // Clouds
    ctx.fillStyle = `rgba(255, 255, 255, ${0.8 - skyProg * 0.6})`;
    clouds.forEach(c => {
        let cx = (c.x - camX * c.speed) % 2400;
        if (cx < -200) cx += 2400;
        ctx.beginPath();
        ctx.arc(cx, c.y, c.w/2.5, 0, Math.PI*2);
        ctx.arc(cx + c.w/3, c.y - 10, c.w/3, 0, Math.PI*2);
        ctx.arc(cx + c.w/1.5, c.y, c.w/3, 0, Math.PI*2);
        ctx.fill();
    });

    ctx.save(); ctx.translate(-camX, 0);
    
    if(castleImg.complete) {
        ctx.drawImage(castleImg, castlePos.x, castlePos.y, castlePos.w, castlePos.h);
        ctx.fillStyle = "black";
        ctx.fillRect(castlePos.x+castlePos.w/2-40-(gateOpen*45), castlePos.y+castlePos.h-130, 45, 110);
        ctx.fillRect(castlePos.x+castlePos.w/2+(gateOpen*45), castlePos.y+castlePos.h-130, 45, 110);
    }

    ctx.fillStyle = "#3e2723"; platforms.forEach(plat => ctx.fillRect(plat.x, plat.y, plat.w, plat.h));
    enemies.forEach(en => { if(en.img.complete) ctx.drawImage(en.img, en.x, en.y, en.w, en.h); });
    ctx.fillStyle = "#0ff"; bullets.forEach(b => { ctx.beginPath(); ctx.arc(b.x, b.y, 14, 0, Math.PI*2); ctx.fill(); });
    confetti.forEach(c => { ctx.fillStyle=c.color; ctx.fillRect(c.x, c.y, c.size, c.size); });

    if(!(invuln%4 > 2) && mariaImg.complete) {
        ctx.save();
        if(p.face===-1) { ctx.translate(p.x+p.w, p.y); ctx.scale(-1,1); ctx.drawImage(mariaImg,0,0,p.w,p.h); }
        else ctx.drawImage(mariaImg, p.x, p.y, p.w, p.h);
        ctx.restore();
    }
    ctx.restore();
}
requestAnimationFrame(update);
</script>
</body>
</html>
